# Анализ реализации векторного поиска

## Компоненты реализации

### 1. Генерация embeddings
- Выбор модели `all-MiniLM-L6-v2` оптимален для старта:
  * Легкая (размер ~80MB)
  * Быстрая (может работать на CPU)
  * Хорошее качество для русского языка
  * Размерность векторов = 384 (компактно)

### 2. Сохранение в БД
- В текущей схеме у нас уже есть поле `embedding` в таблице `chat_history`
- Нужно будет изменить тип поля с `BLOB` на специальный векторный тип
- В SQLite нет встроенной поддержки векторов, возможно понадобится:
  * Либо переход на PostgreSQL с расширением pgvector
  * Либо использование специализированных векторных БД (Milvus, Qdrant)

### 3. Векторный поиск
- Косинусная близость - хороший выбор метрики
- Текущий SQL запрос работает для PostgreSQL с pgvector
- Для SQLite нужно будет:
  * Либо реализовать косинусную близость на Python
  * Либо использовать внешние библиотеки (FAISS, Annoy)

### 4. Интеграция в контекст
- Хорошо вписывается в текущую архитектуру
- Можно комбинировать с существующим хронологическим подходом:
  * Последние N сообщений для текущего контекста
  * Похожие сообщения из всей истории
  * Взвешивание по времени и релевантности

## Потенциальные улучшения
1. Добавить асинхронную генерацию embeddings
2. Реализовать батчинг для векторных операций
3. Добавить предварительную фильтрацию по метаданным
4. Внедрить систему оценки качества релевантности
5. Реализовать адаптивный выбор количества контекстных сообщений
